
@using System.Text.RegularExpressions;

@model SFA.DAS.AssessorService.Web.ViewModels.Organisation.OrganisationSearchViewModel

@{
    ViewBag.Title = "Confirm organisation";
    Layout = "_Layout";
    
    var organisation = Model.Organisations?.FirstOrDefault();
    var organisationType = Model.OrganisationTypes?.FirstOrDefault(ot => ot.Type == organisation?.OrganisationType);

    var epaoRegex = new Regex(@"[eE][pP][aA][0-9]{4,9}$");
    var epaoId = organisation?.Id?.Split(',').FirstOrDefault(id => epaoRegex.Match(id).Success);
}

<a asp-action="Results" asp-controller="OrganisationSearch" asp-route-searchString="@Model.SearchString" class="govuk-back-link">Back to search results</a>

<main class="govuk-main-wrapper " id="main-content" role="main">
    <div class="govuk-grid-row">
        @if (organisation != null)
        {
            <div class="govuk-grid-column-two-thirds">
                <form method="post" asp-action="DealingWithRequest" asp-controller="OrganisationSearch" novalidate>
                    <input asp-for="SearchString" type="hidden" />
                    <input asp-for="Name" type="hidden" />
                    <input asp-for="Ukprn" type="hidden" />
                    <input asp-for="OrganisationType" type="hidden" />
                    <input asp-for="Postcode" type="hidden" />


                    <div class="govuk-form-group">
                        @if (organisation.OrganisationReferenceType  != "RoEPAO")
                        {
                            <div class="panel panel-border-wide">
                                <p class="govuk-body">
                                    <span class="bold-small"> @Model.Name</span> is not recognised as a registered organisation.
                                    If you continue, you will be taken to the new organisation registration application.
                                </p>
                            </div>
                        }
                        <h1 class="govuk-heading-xl">Confirm organisation</h1>

                        <h2 class="govuk-heading-m">@organisation.Name</h2>

                        <dl class="govuk-summary-list">
                            @if (organisation.Address?.Postcode != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Address
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @{ var addressArray = new[] { organisation.Address?.Address1, organisation.Address?.City, organisation.Address.Postcode }; }
                                        @Html.Raw(string.Join("<br>", addressArray.Where(s => !string.IsNullOrEmpty(s))))
                                    </dd>
                                </div>
                            }

                            @if (organisation.TradingName != null || organisation.ProviderName != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Trading name
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @(organisation.TradingName ?? organisation.ProviderName)
                                    </dd>
                                </div>
                            }

                            @if (organisationType?.TypeDescription != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Type
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @organisationType.TypeDescription
                                    </dd>
                                </div>
                            }

                            @if (organisation.Ukprn != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        UKPRN
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @organisation.Ukprn
                                    </dd>
                                </div>
                            }

                            @if (epaoId != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        EPAO ID
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @epaoId
                                    </dd>
                                </div>
                            }

                            @if (organisation.CompanyNumber != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Company number
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @organisation.CompanyNumber
                                    </dd>
                                </div>
                            }

                            @if (organisation.CharityNumber != null)
                            {
                                <div class="govuk-summary-list__row">
                                    <dt class="govuk-summary-list__key">
                                        Charity number
                                    </dt>
                                    <dd class="govuk-summary-list__value">
                                        @organisation.CharityNumber
                                    </dd>
                                </div>
                            }

                        </dl>


                    </div>
                    <button type="submit" class="govuk-button">Confirm</button>
                </form>

                <p class="govuk-body">
                    <a class="govuk-link" asp-action="Results" asp-controller="OrganisationSearch" asp-route-searchString="@Model.SearchString">Choose a different organisation</a>
                </p>
            </div>
        }
        else
        {
            <div class="govuk-grid-column-two-thirds">
                <div class="govuk-form-group">
                    <h1 class="govuk-heading-xl">We cannot find your organisation details</h1>
                    <p class="govuk-body">Check the:</p>
                    <ul class="govuk-list govuk-list--bullet">
                        <li>spelling of the name</li>
                        <li><abbr title="UK provider reference number">UKPRN</abbr> is correct</li>
                        <li><abbr title="End-point assessor organisation">EPAO ID</abbr> is correct</li>
                        <li>company number</li>
                        <li>charity number</li>
                    </ul>
                </div>

                <p class="govuk-body">
                    <a class="govuk-link" asp-action="Results" asp-controller="OrganisationSearch" asp-route-searchString="@Model.SearchString">Back to search results</a>
                </p>
            </div>
        }
    </div>
</main>